// ã‚«ã‚±ã‚¤ã‚·ã‚§ã‚¢ Prisma Schema
// å¤«å©¦å‘ã‘å®¶è¨ˆå…±æœ‰ã‚¢ãƒ—ãƒª

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ============================================================
// Enums
// ============================================================

enum Role {
  ADMIN
  MEMBER
}

enum Visibility {
  PUBLIC
  AMOUNT_ONLY
  CATEGORY_TOTAL
}

enum ExpenseSource {
  CSV_IMPORT
  MANUAL
}

// ============================================================
// User â€” ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤«=ADMIN / å¦»=MEMBERï¼‰
// ============================================================

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  expenses              Expense[]
  installments          Installment[]
  csvImports            CsvImport[]   @relation("CsvImportOwner")
  importedCsvs          CsvImport[]   @relation("CsvImportedBy")
  categoryVisibilities  CategoryVisibilitySetting[]

  @@map("users")
}

// ============================================================
// Category â€” æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª
// ============================================================

model Category {
  id                String     @id @default(cuid())
  name              String
  icon              String     @default("ğŸ“¦")
  isFixedCost       Boolean    @default(false)
  defaultVisibility Visibility @default(PUBLIC)
  sortOrder         Int        @default(0)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  expenses           Expense[]
  budgets            Budget[]
  visibilitySettings CategoryVisibilitySetting[]

  @@map("categories")
}

// ============================================================
// CategoryVisibilitySetting â€” ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚«ãƒ†ã‚´ãƒªå…¬é–‹ãƒ¬ãƒ™ãƒ«è¨­å®š
// ============================================================

model CategoryVisibilitySetting {
  userId     String
  categoryId String
  visibility Visibility @default(PUBLIC)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([userId, categoryId])
  @@map("category_visibility_settings")
}

// ============================================================
// Expense â€” æ”¯å‡ºæ˜ç´°
// ============================================================

model Expense {
  id             String        @id @default(cuid())
  userId         String
  date           DateTime
  amount         Int           // å††å˜ä½ï¼ˆintegerï¼‰
  description    String
  categoryId     String?
  visibility     Visibility    @default(PUBLIC)
  isSubstitute   Boolean       @default(false) // ç«‹æ›¿ãƒ•ãƒ©ã‚°
  actualAmount   Int?          // ç«‹æ›¿æ™‚ã®è‡ªå·±è² æ‹…é¡
  source         ExpenseSource @default(MANUAL)
  csvImportId    String?
  aiCategorized  Boolean       @default(false)
  confirmed      Boolean       @default(false)
  dedupeHash     String?       // CSVé‡è¤‡æ¤œçŸ¥ç”¨ãƒãƒƒã‚·ãƒ¥ï¼ˆuserId+cardType+date+description+amountï¼‰
  memo           String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user      User       @relation(fields: [userId], references: [id])
  category  Category?  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  csvImport CsvImport? @relation(fields: [csvImportId], references: [id])

  @@index([userId, dedupeHash])
  @@index([userId])
  @@index([userId, date])
  @@index([date])
  @@index([categoryId])
  @@index([csvImportId])
  @@map("expenses")
}

// ============================================================
// Budget â€” æœˆæ¬¡äºˆç®—
// ============================================================

model Budget {
  id         String   @id @default(cuid())
  yearMonth  String   // "YYYY-MM" å½¢å¼
  categoryId String?  // nullãªã‚‰å…¨ä½“äºˆç®—
  amount     Int      // å††å˜ä½
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  category Category? @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@unique([yearMonth, categoryId])
  @@map("budgets")
}

// ============================================================
// Installment â€” åˆ†å‰²æ‰•ã„ç®¡ç†
// ============================================================

model Installment {
  id              String     @id @default(cuid())
  userId          String
  description     String
  totalAmount     Int        // ç·é¡ï¼ˆå††ï¼‰
  monthlyAmount   Int        // æœˆã€…ã®æ”¯æ‰•é¡ï¼ˆå††ï¼‰
  totalMonths     Int        // å…¨å›æ•°
  remainingMonths Int        // æ®‹å›æ•°
  startDate       DateTime
  visibility      Visibility @default(PUBLIC)
  fee             Int        @default(0) // åˆ†å‰²æ‰‹æ•°æ–™ï¼ˆå††ï¼‰
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("installments")
}

// ============================================================
// CsvImport â€” CSVå–ã‚Šè¾¼ã¿å±¥æ­´
// ============================================================

model CsvImport {
  id               String   @id @default(cuid())
  userId           String   // ã‚«ãƒ¼ãƒ‰æ‰€æœ‰è€…
  importedById     String   // å®Ÿéš›ã«å–ã‚Šè¾¼ã‚“ã ãƒ¦ãƒ¼ã‚¶ãƒ¼
  cardType         String   // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥IDï¼ˆepos, mufg_jcb, mufg_visaï¼‰
  cardName         String   // è¡¨ç¤ºç”¨ã‚«ãƒ¼ãƒ‰å
  yearMonth        String   // "YYYY-MM" å½¢å¼
  importedAt       DateTime @default(now())
  recordCount      Int      @default(0)
  unconfirmedCount Int      @default(0)
  fileHash         String   // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ï¼ˆé‡è¤‡å–ã‚Šè¾¼ã¿é˜²æ­¢ï¼‰
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user       User      @relation("CsvImportOwner", fields: [userId], references: [id])
  importedBy User      @relation("CsvImportedBy", fields: [importedById], references: [id])
  expenses   Expense[]

  @@index([userId])
  @@index([importedById])
  @@index([userId, cardType, yearMonth])
  @@unique([userId, fileHash])
  @@map("csv_imports")
}
