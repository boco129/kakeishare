# 家計共有アプリ「カケイシェア」要件定義書

> **最終更新**: 2026-02-28
> **ステータス**: Phase 2 完了・Phase 3 開発中（Issue #36-#46）

## 1. プロジェクト概要

### 1.1 背景・課題

| 項目 | 内容 |
|------|------|
| **現状** | 家計の全体像が把握できておらず、夫がほぼ全額を負担。妻側の支出も不透明 |
| **核心の問題** | 妻に浪費癖があり、家計簿を継続できない。カードの分割払いを黙って行い、破綻して初めて発覚する |
| **複雑化要因** | 妻が飲み会で全員分を立替払いし、後日現金/振込で回収するため、カード明細＝実支出にならない |
| **方針** | 支出開示は夫婦対等に行う。一方的な監視ではなく、家族としての家計を共同管理する |

### 1.2 ゴール

1. 家計全体（夫婦合算）の支出を一元的に見える化する
2. 「誰が」「何に」いくら使ったかを記録・共有する
3. 破綻する前に予算超過を検知し、早期に気づけるようにする
4. 家計の負担バランスを可視化し、分担見直しのきっかけにする
5. Claude連携で分析・提案・予測を受けられるようにする
6. **個人のプライバシーを守りつつ、家計全体の透明性を確保する**

### 1.3 開発方針

- **開発者**: 本人（業務レベルのプログラミング経験あり）
- **目的**: 実用アプリの構築 + Claude API活用の習熟
- **形式**: Webアプリ（iPhone / Android 両対応のためブラウザベース）

---

## 2. ユーザーと利用環境

| 項目 | 内容 |
|------|------|
| **ユーザー** | 夫（メイン管理者）、妻 |
| **デバイス** | 夫: iPhone or Android、妻: もう一方（異なるOS） |
| **入力者** | 主に夫。妻の手入力は期待しない |
| **データソース** | カード明細CSV（主）、手入力（補助） |
| **妻のカード** | エポスカード（妻名義） |
| **夫のカード** | MUFG JCB / MUFG VISA |

---

## 3. 機能要件

### 3.1 データ取り込み（CSV インポート）

| 機能 | 詳細 |
|------|------|
| CSV取り込み | カード会社サイトからダウンロードしたCSVを取り込む |
| カラムマッピング | CSV形式が異なるカード会社に対応するため、カラムの対応付けをプリセット＋カスタム設定可能にする |
| 所有者の設定 | 取り込み時に「夫のカード」「妻のカード」を指定 |
| 重複検知 | 日付+金額+店舗名のハッシュで同一明細の二重取り込みを防止 |
| LLMカテゴリ自動分類 | 取り込んだ明細の店舗名・内容からClaude APIでカテゴリを自動推定 |
| プライバシー自動適用 | カテゴリのデフォルト公開レベルに基づき、取り込み時に自動でプライバシーレベルを付与 |
| 手動修正 | 自動分類結果・プライバシーレベルを人間が確認・修正できるUI |

> **実装状況（2026-02-28時点）**: CSV取り込みAPI 4エンドポイント実装済み（`/api/csv-import`, `/preview`, `/status`, `/history`）。エポスカード・MUFG JCB・MUFG VISAのプリセットマッピング実装済み。csv-parse + iconv-lite でShift_JIS対応済み。LLMカテゴリ自動分類は Phase 4 で実装予定。

### 3.2 CSV取得方法（カード別）

#### エポスカード（妻）

エポスカードのCSV/PDFダウンロードはPC限定であり、妻にPC操作は期待できない。以下の方法で取得する。

| 方法 | 詳細 | 優先度 |
|------|------|--------|
| **夫がエポスNetにログインしてCSVダウンロード** | 妻のエポスNetのID/パスワードを共有してもらい、夫がPCから月1回ダウンロード。最も確実で妻の操作不要 | **メイン** |
| **エポス利用通知メール活用** | カード利用時にほぼリアルタイムでメール通知される機能を有効化。大きな出費の早期検知用。ただし1,000円未満やApple Pay等は通知対象外 | **補助（早期検知）** |
| **エポスお支払予定額通知サービス** | 支払予定額が設定金額（例: 5万円/10万円）を超えた翌日に通知。予算超過の自動アラート | **補助（アラート）** |

※マネーフォワード等の中間サービス経由は、そちらで完結してしまう懸念があるため不採用

#### 夫のカード（MUFG JCB / MUFG VISA）

夫自身がカード会社サイトからCSVをダウンロードして取り込む。

> **実装状況（2026-02-28時点）**: エポスカード・MUFG JCB・MUFG VISA の3種類のCSVマッピング実装済み（`src/lib/csv/mappings/`）。

### 3.3 CSV取り込みタスク管理

CSV取り込み忘れを防ぎ、データの鮮度を保つための仕組み。

| 機能 | 詳細 |
|------|------|
| 取り込みリマインド通知 | 「今月のCSV取り込みがまだです」をLINEで通知（例: 締め日の3日後） |
| 取り込み完了通知 | 「○件取り込みました、未分類が△件あります」をLINEで通知 |
| 取り込み履歴管理 | いつ・誰の・何件取り込んだかのログを記録し、アプリ上で確認可能 |
| 取り込みステータス | ダッシュボードに「夫: 2月分 ✅ / 妻: 2月分 ❌ 未取り込み」を表示 |

> **実装状況（2026-02-28時点）**: 取り込み履歴・ステータスAPI実装済み（`/api/csv-import/status`, `/api/csv-import/history`）。LINE通知は Phase 5 で実装予定。

### 3.4 支出管理

| 機能 | 詳細 |
|------|------|
| 手入力 | 補助的に手動で支出を登録できる |
| 立替マーク | 「この支出は立替」とフラグを立て、実際の自己負担額を入力できる |
| カテゴリ管理 | 食費・日用品・交通費・交際費・固定費（家賃/光熱費/保険/サブスク）等。カスタマイズ可能 |
| 分割払い管理 | 分割の総額・残回数・月々の支払額を登録し、「見えない負債」を可視化 |

> **実装状況（2026-02-28時点）**: 支出API CRUD 実装済み（`/api/expenses`, `/api/expenses/[id]`）。手入力・立替マーク・自己負担額・プライバシーフィルター・DB側ページネーション対応済み。カテゴリ管理CRUD 実装済み（`/api/categories` 4エンドポイント）。分割払いAPI は Phase 3 で実装予定（Issue #38）。

### 3.5 プライバシー制御

夫婦双方に平等に適用されるプライバシー機能。家計全体の透明性を保ちつつ、個人の支出詳細を保護する。

#### 3段階の公開レベル

| レベル | 相手から見える情報 | 使用例 |
|--------|-------------------|--------|
| **公開** | 日付・金額・店舗名・カテゴリすべて | 食費、日用品、光熱費など家計支出 |
| **金額のみ公開** | 日付・金額・カテゴリは見えるが、店舗名・内容は「個人支出」と表示 | 衣服、美容、交際費、医療など |
| **カテゴリ合計のみ** | 明細は一切見えず、月の「カテゴリ名: 合計¥XX,XXX」とだけ表示 | 個人娯楽、趣味など完全プライベート |

#### カテゴリ別デフォルト公開レベル

| カテゴリ | デフォルト | 理由 |
|---------|-----------|------|
| 食費 | 公開 | 家計の主要支出 |
| 日用品 | 公開 | 家計の主要支出 |
| 住居（家賃） | 公開 | 固定費 |
| 光熱費 | 公開 | 固定費 |
| 通信費 | 公開 | 固定費 |
| 保険 | 公開 | 固定費 |
| サブスク | 公開 | 固定費 |
| 交通費 | 公開 | 日常支出 |
| 交際費 | 金額のみ公開 | 相手・店舗はプライベート |
| 衣服・美容 | 金額のみ公開 | 金額は家計に影響、詳細はプライベート |
| 医療 | 金額のみ公開 | 金額は家計に影響、内容はセンシティブ |
| 教育 | 公開 | 家計の投資支出 |
| 個人娯楽・趣味 | カテゴリ合計のみ | 完全プライベート |
| その他 | 金額のみ公開 | 安全側に倒す |

#### 適用ルール

- CSV取り込み → Claude自動分類 → カテゴリのデフォルト公開レベルが自動適用
- 個別の明細は手動で公開レベルを上書き可能（自分の支出のみ）
- カテゴリのデフォルト公開レベルは設定画面から夫婦それぞれが変更可能（`CategoryVisibilitySetting` テーブルで実装済み）
- Claude連携（レポート・チャット）に渡すデータにもプライバシーレベルを反映し、非公開の詳細は集計値のみ渡す

> **実装状況（2026-02-28時点）**: プライバシー3段階フィルター実装済み（`src/lib/privacy/`）。API層でDB側フィルタリング（VISIBLE_TO_OTHERS定数） + アプリ側マスク処理を適用。ユーザー別カテゴリ公開設定API（`/api/categories/[id]/visibility`）実装済み。

### 3.6 ダッシュボード

| 機能 | 詳細 |
|------|------|
| 今月の残予算 | アプリを開いたとき最初に表示。予算 − 実績 = あといくら使えるか |
| カテゴリ別支出 | 円グラフ/棒グラフで内訳表示（プライバシーレベルに従い表示制御） |
| 夫婦別支出 | 誰がどれだけ家計を負担しているか比率表示 |
| 月次推移 | 過去数ヶ月のトレンドを折れ線グラフで表示 |
| 分割払い残高 | 未完了の分割払いの残額サマリー |
| CSV取り込みステータス | 今月の取り込み状況（夫✅/妻❌など） |

> **実装状況（2026-02-28時点）**: ダッシュボード画面は基本レイアウトのみ実装済み（グラフ・予算表示は Phase 3 で実装予定、Issue #41）。CSV取り込みステータスAPI（`/api/csv-import/status`）は実装済み。

### 3.7 予算管理

| 機能 | 詳細 |
|------|------|
| 月次予算設定 | 家計全体、およびカテゴリ別に予算を設定 |
| 予算超過アラート | 予算の80%/100%到達時に警告表示 |
| 前月比較 | 前月同時期との比較で使いすぎを検知 |

> **実装状況（2026-02-28時点）**: 予算データモデル（`budgets` テーブル）は実装済み。予算API CRUD は Phase 3 で実装予定（Issue #37）。

### 3.8 家計レビュー画面

| 機能 | 詳細 |
|------|------|
| 月次レビュー | 夫婦で一緒に見ながら振り返るための専用画面 |
| 表示内容 | 今月のサマリー / カテゴリ別実績 vs 予算 / 夫婦負担比率 / 先月比 |
| プライバシー対応 | レビュー画面では各ユーザーの公開レベルに従い表示。非公開の支出はカテゴリ合計として反映 |
| Claude解説 | レビュー画面にClaudeによるコメント・気づきを表示 |

> **実装状況（2026-02-28時点）**: レビュー画面はプレースホルダーのみ。Phase 3 で集計・グラフ実装予定（Issue #44）、Claude解説は Phase 4。

### 3.9 通知・リマインド

| 機能 | 詳細 |
|------|------|
| 週次サマリー | 今週の支出合計と残予算をLINE等に通知 |
| 月次レポート通知 | 月末に家計レポートを生成し通知 |
| 未分類リマインド | カテゴリ未確認の支出があればリマインド |
| CSV取り込みリマインド | 締め日後にCSV未取り込みをリマインド |

> **実装状況（2026-02-28時点）**: 未着手。Phase 5 で LINE Messaging API と合わせて実装予定。

### 3.10 Claude連携（AI機能）

| 機能 | 詳細 | 優先度 |
|------|------|--------|
| カテゴリ自動分類 | CSV取り込み時に店舗名からカテゴリを推定し、プライバシーレベルも自動付与 | **高** |
| 月次レポート生成 | 月末に家計データを基にレポート文章を自動生成（プライバシー考慮済み集計値で生成） | **高** |
| 削減提案 | カテゴリ別に無駄遣いの傾向と削減案を提示 | **中** |
| 来月の支出予測 | 過去データのトレンドから来月の支出を予測 | **中** |
| チャットアドバイザー | 家計データを踏まえた自由質問（例:「旅行のための貯金、いつまでに貯まる？」） | **中** |

> **実装状況（2026-02-28時点）**: 未着手。Phase 4 で Anthropic SDK 導入後に実装予定。

---

## 4. 非機能要件

| 項目 | 内容 |
|------|------|
| **対応端末** | スマホブラウザ（iOS Safari / Android Chrome）メイン、PCブラウザも可 |
| **レスポンシブ** | モバイルファースト設計 |
| **認証** | シンプルなユーザー識別（夫/妻の切り替え）。初期はパスワードベースでOK |
| **データ保存** | サーバーサイドDB（後述のアーキテクチャ参照） |
| **セキュリティ** | HTTPS必須、家計データは機微情報のため最低限の暗号化 |
| **プライバシー** | プライバシーレベルはDB・API・UIすべてのレイヤーで遵守する |

---

## 5. アーキテクチャ（実装確定）

```
┌──────────────────────────────────────────────┐
│                  フロントエンド                   │
│      Next.js 16 (App Router) + Tailwind CSS v4   │
│              PWA対応（Phase 6 で予定）              │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │         プライバシーフィルター（UI層）        │  │
│  │  ログインユーザーに応じて表示内容を制御       │  │
│  └──────────────────────────────────────────┘  │
└──────────────┬───────────────────────────────┘
               │ REST API (Route Handlers)
┌──────────────▼───────────────────────────────┐
│                 バックエンド                      │
│          Next.js Route Handlers (/api)           │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │       プライバシーフィルター（API層）         │  │
│  │  リクエスト元ユーザーに応じてレスポンスを     │  │
│  │  フィルタリング（店舗名マスク等）             │  │
│  └──────────────────────────────────────────┘  │
│                                                  │
│  ┌─────────┐  ┌──────────┐  ┌──────────────┐  │
│  │CSV解析   │  │予算計算   │  │通知スケジュール│  │
│  └─────────┘  └──────────┘  └──────────────┘  │
│                      │                           │
│           ┌──────────▼──────────┐               │
│           │   Claude API連携    │               │
│           │  ・カテゴリ分類      │               │
│           │  ・レポート生成      │               │
│           │  ・チャットアドバイザー│               │
│           └─────────────────────┘               │
└──────────────┬───────────────────────────────┘
               │
┌──────────────▼───────────────────────────────┐
│                データベース                      │
│     SQLite（開発） / Supabase PostgreSQL（本番）   │
│                                                  │
│  テーブル: users, expenses, categories,          │
│           budgets, installments, csv_imports,    │
│           category_visibility_settings           │
└──────────────────────────────────────────────┘
               │
┌──────────────▼───────────────────────────────┐
│              外部サービス連携                     │
│  ・Anthropic API（Claude）                       │
│  ・LINE Messaging API（通知）                    │
│  ・Vercel（ホスティング）                          │
└──────────────────────────────────────────────┘
```

### 5.1 技術スタック（実装済み）

| レイヤー | 採用技術 | バージョン |
|----------|----------|-----------|
| フレームワーク | Next.js (App Router) | 16.1.6 |
| 言語 | TypeScript | ^5 |
| ランタイム | React | 19.2.3 |
| UI | Tailwind CSS + shadcn/ui | v4 |
| ORM | Prisma | 7.4.1 |
| DB（開発） | SQLite (better-sqlite3 adapter) | — |
| DB（本番） | Supabase (PostgreSQL) | — |
| 認証 | next-auth (Credentials) | 5.0.0-beta.30 |
| バリデーション | Zod | 4.3.6 |
| フォーム | react-hook-form | 7.71.2 |
| CSV解析 | csv-parse + iconv-lite | 6.1.0 / 0.7.2 |
| パスワード | bcryptjs | 3.0.3 |
| テスト（単体） | Vitest + @vitest/coverage-v8 | 4.0.18 |
| テスト（E2E） | Playwright | 1.58.2 |
| ホスティング | Vercel | — |
| パッケージマネージャ | pnpm | — |
| Node.js | >= 20.19.0 | — |

#### 今後導入予定の技術

| レイヤー | 技術 | 導入予定 |
|----------|------|---------|
| AI連携 | Anthropic SDK (TypeScript) | Phase 4 |
| 通知 | LINE Messaging API | Phase 5 |
| グラフ | Recharts + shadcn/ui chart | Phase 3 |

### 5.2 実装済みAPI（12 エンドポイント）

| パス | メソッド | 概要 |
|------|---------|------|
| `/api/auth/[...nextauth]` | GET/POST | NextAuth 認証 |
| `/api/expenses` | GET/POST | 支出一覧（DB側ページネーション）/ 新規登録 |
| `/api/expenses/[id]` | PATCH/DELETE | 支出更新 / 削除 |
| `/api/categories` | GET/POST | カテゴリ一覧 / 新規作成 |
| `/api/categories/[id]` | PATCH/DELETE | カテゴリ更新 / 削除 |
| `/api/categories/[id]/visibility` | PATCH | ユーザー別カテゴリ公開設定 |
| `/api/categories/reorder` | PATCH | カテゴリ並び替え |
| `/api/csv-import` | POST | CSV取り込み実行 |
| `/api/csv-import/preview` | POST | CSV取り込みプレビュー |
| `/api/csv-import/status` | GET | 取り込みステータス |
| `/api/csv-import/history` | GET | 取り込み履歴 |
| `/api/dev/reset-rate-limit` | POST | レート制限リセット（CI専用） |

---

## 6. データモデル（概要）

> **注記**: ID は全テーブル共通で `String (cuid)` を使用。以下の表では省略する。

### users
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| name | string | 表示名（夫/妻） |
| role | enum | ADMIN / MEMBER |
| email | string | ログイン用（unique） |
| password | string | ハッシュ化パスワード（bcryptjs） |

### expenses
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| user_id | FK | 支払った人 |
| date | date | 支出日 |
| amount | integer | 金額（円） |
| description | string | 内容・店舗名 |
| category_id | FK | カテゴリ |
| is_substitute | boolean | 立替かどうか |
| actual_amount | integer | 立替の場合の自己負担額 |
| source | enum | CSV_IMPORT / MANUAL |
| csv_import_id | FK | 取り込み元（重複検知用） |
| ai_categorized | boolean | AIが分類したか |
| confirmed | boolean | 人間が確認済みか |
| **visibility** | **enum** | **PUBLIC / AMOUNT_ONLY / CATEGORY_TOTAL** |
| memo | string? | メモ（任意） |
| dedupeHash | string? | 重複検知用ハッシュ（userId+cardType+date+description+amount） |

### categories
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| name | string | カテゴリ名 |
| icon | string | 表示用アイコン |
| is_fixed_cost | boolean | 固定費かどうか |
| sort_order | integer | 表示順 |
| **default_visibility** | **enum** | **カテゴリごとのデフォルト公開レベル** |

### installments（分割払い）
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| user_id | FK | 誰の分割払いか |
| description | string | 何を買ったか |
| total_amount | integer | 総額 |
| monthly_amount | integer | 月々の支払額 |
| total_months | integer | 全回数 |
| remaining_months | integer | 残回数 |
| start_date | date | 開始月 |
| **visibility** | **enum** | **PUBLIC / AMOUNT_ONLY / CATEGORY_TOTAL** |
| fee | integer | 分割手数料（デフォルト0） |

### budgets（データモデル実装済み・API は Phase 3 で実装予定）
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| year_month | string | 対象年月 (YYYY-MM) |
| category_id | FK | カテゴリ（nullなら全体予算） |
| amount | integer | 予算額 |

### csv_imports
| カラム | 型 | 説明 |
|--------|------|------|
| id | String(cuid) | 主キー |
| user_id | FK | 誰のカード分か |
| imported_by_id | FK | 誰が取り込んだか |
| imported_at | datetime | 取り込み日時 |
| card_name | string | カード名（例: エポスカード） |
| year_month | string | 対象年月 (YYYY-MM) |
| record_count | integer | 取り込み件数 |
| unconfirmed_count | integer | 未確認件数 |
| card_type | string | カード種別ID（epos, mufg_jcb, mufg_visa） |
| file_hash | string | ファイルハッシュ（重複取り込み防止） |

### category_visibility_settings（ユーザー別カテゴリ公開設定）
| カラム | 型 | 説明 |
|--------|------|------|
| user_id | FK | 設定するユーザー（複合主キー） |
| category_id | FK | 対象カテゴリ（複合主キー） |
| visibility | enum | PUBLIC / AMOUNT_ONLY / CATEGORY_TOTAL |

> 複合主キー: `(user_id, category_id)`。カテゴリの `default_visibility` をユーザーごとに上書きする設定。未設定の場合はカテゴリのデフォルトが適用される。

---

## 7. 開発ロードマップ

### Phase 1: 基盤構築 ✅ 完了
- [x] Next.js プロジェクト初期化 + Tailwind CSS v4 設定
- [x] Prisma + SQLite でDB構築（プライバシー関連カラム含む）
- [x] 認証（next-auth v5 beta でCredentials認証）
- [x] 基本的なレイアウト・ナビゲーション（モバイルファースト）
- [x] レート制限・監査ログ・環境変数バリデーション

### Phase 2: コア機能 ✅ 完了
- [x] 手入力での支出登録（公開レベル選択UI含む）
- [x] CSV取り込み機能（エポスカード・MUFG JCB・MUFG VISAのプリセット対応）
- [x] カテゴリ管理（CRUD + デフォルト公開レベル設定 + ユーザー別上書き）
- [x] 立替マーク・自己負担額の入力
- [x] 支出一覧・フィルタリング（プライバシーフィルター適用 + DB側ページネーション）
- [x] CSV取り込み履歴・ステータス管理
- [x] CI/CD整備（Unit Tests + E2E Tests + カバレッジレポート）

### Phase 3: 可視化・予算（開発中 — Issue #36-#46）
- [ ] 集計ドメイン層の実装（#36）
- [ ] 予算API CRUD（#37）
- [ ] 分割払いAPI CRUD（#38）
- [ ] ダッシュボード集計API（#39）
- [ ] Recharts + shadcn/ui chart 基盤導入（#40）
- [ ] ダッシュボード画面実装（#41）
- [ ] 月次予算管理UI（#42）
- [ ] 分割払い管理UI（#43）
- [ ] レビュー画面実装（#44）
- [ ] E2E・単体テスト拡充 + ドキュメント更新（#45）
- [ ] Phase 3→4 移行準備の洗い出し（#46）

### Phase 4: Claude連携（Issue #47-#52）
- [ ] Anthropic SDK 導入 + AIクライアント基盤（#47）
- [ ] CSV取込カテゴリ自動分類 + プライバシー自動付与（#48）
- [ ] 月次レポート自動生成（#49）
- [ ] 削減提案・支出予測（#50）
- [ ] チャットアドバイザーUI（#51）
- [ ] Phase 4 テスト拡充 + 運用準備 + ドキュメント更新（#52）

### Phase 5: 通知（未着手）
- [ ] LINE Messaging API連携
- [ ] 週次/月次サマリー通知
- [ ] CSV取り込みリマインド通知
- [ ] 未確認支出リマインド
- [ ] 予算超過アラート

### Phase 6: 改善・運用（継続）
- [ ] PWA対応（ホーム画面に追加可能に）
- [ ] 本番DB移行（SQLite → Supabase PostgreSQL）※Vercel デプロイ時に切り替え予定
- [ ] パフォーマンス最適化
- [ ] UX改善（実際に使ってみてのフィードバック反映）

---

## 8. Claude API活用 設計メモ

### 8.1 カテゴリ自動分類 + プライバシー自動付与

```
システムプロンプト:
あなたは家計簿の支出カテゴリ分類アシスタントです。
各明細に対して以下を判定してください:

1. カテゴリ（以下から選択）:
   食費, 日用品, 交通費, 交際費, 衣服・美容, 医療,
   教育, 住居, 光熱費, 通信, 保険, サブスク, 個人娯楽, その他

2. 分類の確信度（high / medium / low）
   ※ lowの場合は confirmed: false として人間の確認を促す

入力: JSON配列（店舗名、金額、日付）
出力: JSON配列（カテゴリ、確信度）

ユーザー入力例:
[
  {"store": "スターバックス", "amount": 580, "date": "2026-02-15"},
  {"store": "Amazon.co.jp", "amount": 3200, "date": "2026-02-16"}
]

出力例:
[
  {"category": "食費", "confidence": "high"},
  {"category": "その他", "confidence": "low"}
]
```

**バッチ処理**: CSV取り込み時は複数件をまとめて1回のAPI呼び出しで処理（コスト効率化）

**プライバシー自動付与**: カテゴリが確定した時点で、categoriesテーブルのdefault_visibilityを自動適用

### 8.2 月次レポート生成

```
システムプロンプト:
あなたは家族の家計アドバイザーです。以下の月次データを分析し、
夫婦で振り返りやすいレポートを日本語で生成してください。

重要な注意事項:
- 「個人娯楽」など非公開カテゴリの支出は合計金額のみ提供されます。
  内訳には言及せず、合計額のみに基づいてコメントしてください。
- 良かった点を先に伝える
- 具体的な数字を交えて説明
- 改善提案は実行可能なものに絞る
- 夫婦間の責任追及にならないトーンで
- 「誰が悪い」ではなく「家族として何ができるか」の視点で

入力データ: { 月次集計JSON（プライバシーフィルター適用済み） }
```

### 8.3 チャットアドバイザー

```
システムプロンプト:
あなたは家計管理の専門アドバイザーです。
以下は家計データのサマリーです:
{家計サマリーJSON（プライバシーフィルター適用済み）}

重要なルール:
- 非公開カテゴリの詳細を推測・質問しないでください
- 個人の責任を追及するような回答は避けてください
- 家族全体として改善する方向でアドバイスしてください
- 具体的な数字に基づいた提案を心がけてください
```

---

## 9. プライバシー制御 設計詳細

### 9.1 データフロー上のプライバシー適用ポイント

```
CSV取り込み
  → Claude分類（※この時点では全データが見える）
  → カテゴリ確定 → デフォルト公開レベル自動付与
  → DB保存（全データ + visibility フラグ）
  
API レスポンス
  → リクエスト元ユーザーを判定
  → 相手の支出のうち visibility に応じてフィルタリング
     - PUBLIC: 全フィールド返却
     - AMOUNT_ONLY: description を「個人支出」にマスク
     - CATEGORY_TOTAL: 個別明細を返さず、集計値のみ返却
  
ダッシュボード / レビュー画面
  → フィルタリング済みAPIレスポンスをそのまま表示
  
Claude連携（レポート / チャット）
  → CATEGORY_TOTAL の支出は集計値のみをプロンプトに含める
  → AMOUNT_ONLY の支出は金額・カテゴリのみ（店舗名なし）
```

### 9.2 自分の支出の閲覧

自分自身の支出は公開レベルに関係なく常にすべての詳細を閲覧可能。プライバシーフィルターは「相手から見たとき」にのみ適用される。

---

## 10. 補足: 既存アプリとの差別化ポイント

| 機能 | 既存アプリ | 本アプリ |
|------|-----------|---------|
| 立替の自己負担額記録 | 割り勘は可能だが、カード決済の一部だけ自己負担にする操作は煩雑 | 「立替」フラグ + 実負担額の直接入力で簡単 |
| 分割払い可視化 | ほぼ対応なし | 総額・残回数・月額を管理し「見えない負債」を可視化 |
| LLMカテゴリ自動分類 | 一部AIレシート機能あり | Claude連携で高精度 + プライバシーレベル自動付与 |
| 家計アドバイザー | なし | Claude連携でレポート・提案・予測・チャット相談 |
| 継続の仕掛け | Push通知程度 | LINE通知 + CSV取り込みリマインド + 夫婦レビュー画面 + AIコメント |
| 入力の手間 | 手入力 or カード連携（API経由） | CSV取り込み（月1〜2回） + AI自動分類で手間最小化 |
| **プライバシー制御** | 口座単位の共有/非共有のみ | **3段階の公開レベル × カテゴリ別デフォルト × 明細個別上書き** |
| **CSV取り込み管理** | なし | **リマインド通知 + 履歴管理 + ステータス表示** |
