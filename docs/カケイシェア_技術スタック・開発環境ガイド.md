# カケイシェア 技術スタック・開発環境ガイド

> **最終更新**: 2026-02-28
> **対象者**: 開発者本人（Mac / VS Code / バックエンド経験あり / フロントエンド学習中）

---

## 1. 技術スタック（確定版）

### 言語: TypeScript（フロント・バック統一）

**選定理由**

Pythonのバックエンド経験があるとのことですが、このプロジェクトではTypeScriptを強く推奨します。

- **フロント・バック統一**: Next.jsでフロントエンドもバックエンドも1つの言語で書ける。Python + React の2言語構成より学習コストが低い
- **Claude Codeとの相性**: Claude CodeはTypeScript/JavaScriptのコード生成が最も得意。型があることでClaude Codeの提案精度も上がる
- **Prisma**: TypeScriptネイティブのORMで、DBスキーマから型が自動生成される。Pythonにはこの水準のORM体験がない
- **エコシステム**: Next.js + Tailwind CSS + Prisma + Anthropic SDK、すべてTypeScriptファーストで設計されている

Pythonを使う場合（FastAPI + React等）、フロント/バック間のデータ型整合を手動で保つ必要があり、個人開発では負担が大きいです。

### フルスタック構成

| レイヤー | 技術 | 備考 |
|----------|------|------|
| **フレームワーク** | Next.js 16 (App Router) | フロント・バック・API一体 |
| **スタイリング** | Tailwind CSS | ユーティリティファースト、Claude Codeが得意 |
| **UIコンポーネント** | shadcn/ui | Tailwind ベース、コピペで追加、カスタマイズ自由 |
| **ORM** | Prisma | 型安全、マイグレーション管理、SQLite↔PostgreSQL移行が容易 |
| **DB（開発）** | SQLite | セットアップ不要、ファイル1つ |
| **DB（本番）** | Supabase (PostgreSQL) | 無料枠あり、Prismaで接続先を変えるだけで移行可能 |
| **認証** | next-auth v5 (beta) | Credentials認証から始められる。Next.js 16対応のv5を採用 |
| **AI連携** | Anthropic SDK (TypeScript) | 公式SDK、型安全（Phase 4で導入予定） |
| **グラフ** | Recharts | React用チャートライブラリ、shadcn/uiと相性良い（Phase 3で導入済み） |
| **通知** | LINE Messaging API | Webhook対応、日本でのリーチ最大（Phase 5以降で導入予定） |
| **ホスティング** | Vercel | Next.js公式、無料枠で十分 |

---

## 2. 開発環境のセットアップ

### 2.1 前提ツール（Mac）

```bash
# Node.js（v20以上が必要）
# nvm経由がおすすめ
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.0/install.sh | bash
nvm install 20
nvm use 20

# pnpm（npmより高速、ディスク効率も良い）
npm install -g pnpm

# Git（Macにはプリインストール済み、最新版が欲しければ brew install git）
git --version

# Claude Code
npm install -g @anthropic-ai/claude-code
```

### 2.2 VS Code 拡張機能（推奨）

| 拡張機能 | 用途 |
|---------|------|
| **Tailwind CSS IntelliSense** | クラス名の自動補完・プレビュー |
| **Prisma** | スキーマファイルのシンタックスハイライト・フォーマット |
| **ESLint** | コード品質チェック |
| **Pretty TypeScript Errors** | TypeScriptエラーを読みやすく表示 |
| **SQLite Viewer** | SQLiteファイルをVS Code内で閲覧 |
| **Thunder Client** | API テスト（Postman的なもの） |

### 2.3 プロジェクト初期化の流れ

```bash
# プロジェクト作成
pnpm create next-app@latest kakeishare --typescript --tailwind --app --src-dir
cd kakeishare

# 主要パッケージ
pnpm add prisma @prisma/client        # ORM
pnpm add next-auth@beta               # 認証（v5系）
pnpm add @anthropic-ai/sdk            # Claude API
pnpm add recharts                      # グラフ
pnpm add zod                           # バリデーション
pnpm add csv-parse iconv-lite           # CSV解析・エンコーディング変換

# shadcn/ui 初期化
pnpm dlx shadcn@latest init

# Prisma 初期化（SQLite）
pnpm prisma init --datasource-provider sqlite
```

---

## 3. Claude Code の活用戦略

### 3.1 プランとリミットの理解

**現在: Plus $20/月プラン**

Claude CodeはPlusプランで利用可能です。重要な注意点として、claude.ai（チャット）とClaude Codeは**同じ使用枠を共有**します。

- 5時間ローリングウィンドウでリセット
- Plusプランでは1ウィンドウあたり概ね10〜40プロンプト程度（コード量・コンテキストサイズで変動）
- 使い切った場合は、リセットを待つか、API クレジットに切り替える選択肢が提示される

**コスト効率を最大化するコツ**

- 1つのプロンプトに複数のタスクをまとめる（「ファイルAを作って、Bも修正して」）
- 新しい会話を始めてコンテキストをリセットする（長い会話はトークンを消費）
- `/status` コマンドで残り容量を確認する
- 設計・要件の議論はclaude.ai（このチャット）で行い、Claude Codeは実装に集中させる

**Proプラン（$100/月 = Max 5x）を検討すべきタイミング**

- Phase 2（コア機能）の開発に入り、頻繁にリミットに当たる場合
- 1日に複数時間集中して開発する場合

### 3.2 Claude Code の基本ワークフロー

```bash
# プロジェクトディレクトリで起動
cd ~/projects/kakeishare
claude

# 典型的な使い方
> Prismaスキーマを要件定義書のデータモデルに従って作成して
> このCSVのフォーマットを解析して、カラムマッピング機能を実装して
> 支出一覧ページをshadcn/uiのDataTableで作って
> このエラーを修正して: [エラーメッセージ貼り付け]
```

**CLAUDE.md ファイル（プロジェクトルートに配置）**

Claude Codeはプロジェクトルートの `CLAUDE.md` を自動で読みます。ここにプロジェクトのルール・方針を書いておくと、毎回説明する手間が省けます。

```markdown
# CLAUDE.md

## プロジェクト概要
家計共有Webアプリ「カケイシェア」。夫婦の支出を一元管理する。

## 技術スタック
- Next.js 16 (App Router) + TypeScript
- Prisma + SQLite（開発）
- Tailwind CSS + shadcn/ui
- Anthropic SDK for Claude API

## コーディングルール
- Server Components をデフォルトにする（"use client" は必要な場合のみ）
- API ルートは app/api/ に配置
- Zodでバリデーション
- 日本語コメント推奨
- コンポーネントは src/components/ に配置
- DB操作は src/lib/db/ に集約

## 重要な業務ルール
- プライバシーレベル（PUBLIC / AMOUNT_ONLY / CATEGORY_TOTAL）を必ず考慮
- 支出のフィルタリングはAPI層で行う（フロントで非公開データを受け取らない）
- Claude API呼び出しはバッチ処理でコスト効率化
```

### 3.3 効率的なプロンプトの書き方

**良いプロンプトの例:**
```
CSV取り込み機能を実装して。
- ファイル: src/app/api/csv-import/route.ts
- csv-parse/sync でCSV解析
- エポスカードのフォーマット: 日付,内容,金額（1行目ヘッダー）
- Prismaでexpensesテーブルに保存
- 重複チェック: 日付+金額+店舗名のハッシュ
- use context7 でNext.js App Routerの最新APIを参照
```

**避けるべきプロンプト:**
```
CSV機能作って  ← 情報不足で何往復も必要になる
```

---

## 4. MCP サーバー構成

### 4.1 MCPとは（簡単なおさらい）

MCPはClaude Codeに「追加の能力」を与えるプラグインの仕組みです。たとえば、GitHubのPRを操作したり、最新のライブラリドキュメントを参照したりできます。

MCPサーバーは3つのスコープで設定できます:

| スコープ | 保存先 | 用途 |
|---------|--------|------|
| `user` | `~/.claude/settings.json` | どのプロジェクトでも使う汎用ツール |
| `project` | プロジェクトの `.mcp.json` | このプロジェクト固有のツール |
| `local` | プロジェクト内（Git管理外） | 個人的な設定 |

### 4.2 推奨MCP構成

カケイシェアの開発で役立つMCPサーバーを優先度順に紹介します。

#### ★★★ 必須（最初に入れる）

**① Context7 — 最新ドキュメント参照**

Next.js、Prisma、Tailwind CSS等のドキュメントを最新版で参照できます。Claude Codeの学習データが古い場合に特に有効。

```bash
claude mcp add context7 -s user -- npx -y @upstash/context7-mcp@latest
```

使い方: プロンプトに `use context7` を含めるだけ
```
Prismaのスキーマを作成して。use context7 でPrisma最新ドキュメントを参照
```

**② Playwright — ブラウザ自動テスト**

開発中のWebアプリを実際にブラウザで開いて動作確認できます。UIの実装→確認→修正のサイクルが高速化。

```bash
claude mcp add playwright -s user -- npx -y @playwright/mcp@latest --headless
```

#### ★★ 推奨（開発が軌道に乗ったら追加）

**③ GitHub — リポジトリ操作**

Issue管理、PR作成、コードレビューをClaude Codeから直接操作。

```bash
# GitHubのPersonal Access Tokenが必要
# https://github.com/settings/tokens で作成（repo権限を付与）
claude mcp add github -s user -e GITHUB_TOKEN=ghp_xxxxx -- npx -y @modelcontextprotocol/server-github
```

**④ Fetch — Web取得**

WebページをMarkdownに変換して取得。APIドキュメントやエラーの調査に便利。

```bash
claude mcp add fetch -s user -- npx -y @modelcontextprotocol/server-fetch
```

#### ★ あると便利（必要に応じて）

**⑤ Memory — セッション間メモリ**

Claude Codeのセッション間でコンテキストを保持。長期開発で「前回の続き」がスムーズに。

```bash
claude mcp add memory -s user -- npx -y @modelcontextprotocol/server-memory
```

**⑥ SQLite — DB直接操作**

開発中のSQLiteデータベースにClaude Codeからクエリ実行。デバッグ時に便利。

```bash
claude mcp add sqlite -s project -- npx -y @modelcontextprotocol/server-sqlite
```

### 4.3 MCP設定のコツ

**コンテキスト消費に注意**

MCPサーバーを入れすぎるとコンテキストを圧迫し、Plusプランのリミットを早く使い切ります。

```bash
# 現在のMCPステータス確認（Claude Code内で）
/mcp

# コンテキスト使用量の確認
/context
```

**ENABLE_TOOL_SEARCH の活用**

MCPツールを必要時にだけ動的にロードする設定。コンテキスト消費を大幅削減。

```bash
# ~/.claude/settings.json に追加
{
  "env": {
    "ENABLE_TOOL_SEARCH": "true"
  }
}
```

または起動時に指定:
```bash
ENABLE_TOOL_SEARCH=true claude
```

**おすすめの段階的導入**

1. **Phase 1-2**: Context7 のみ（最小構成でリミット温存）
2. **Phase 2後半**: Playwright 追加（UI実装が増える）
3. **Phase 3以降**: GitHub、Fetch、Memory を必要に応じて追加

---

## 5. プロジェクト構成（ディレクトリ構造）

```
kakeishare/
├── CLAUDE.md                    # Claude Code用プロジェクト設定
├── .mcp.json                    # プロジェクト固有のMCPサーバー設定
├── prisma/
│   ├── schema.prisma            # DBスキーマ定義
│   ├── seed.ts                  # 初期データ投入スクリプト
│   └── dev.db                   # SQLiteデータベースファイル
├── src/
│   ├── app/                     # Next.js App Router
│   │   ├── layout.tsx           # 共通レイアウト
│   │   ├── page.tsx             # ダッシュボード（トップページ）
│   │   ├── expenses/            # 支出管理ページ
│   │   ├── budget/              # 予算管理ページ
│   │   ├── review/              # 家計レビューページ
│   │   ├── settings/            # 設定ページ
│   │   └── api/                 # APIルート
│   │       ├── auth/            # 認証
│   │       ├── expenses/        # 支出CRUD
│   │       ├── csv-import/      # CSV取り込み
│   │       ├── categories/      # カテゴリ管理
│   │       ├── budget/          # 予算管理
│   │       ├── installments/    # 分割払い管理
│   │       └── ai/             # Claude API連携
│   │           ├── categorize/  # カテゴリ自動分類
│   │           ├── report/      # 月次レポート生成
│   │           └── chat/        # チャットアドバイザー
│   ├── components/              # UIコンポーネント
│   │   ├── ui/                  # shadcn/ui コンポーネント
│   │   ├── dashboard/           # ダッシュボード関連
│   │   ├── expenses/            # 支出関連
│   │   └── layout/              # レイアウト関連
│   ├── lib/                     # ユーティリティ・ビジネスロジック
│   │   ├── db.ts                # Prisma Clientシングルトン
│   │   ├── auth.ts              # 認証設定
│   │   ├── csv/                 # CSV解析ロジック
│   │   │   ├── parser.ts        # 汎用CSVパーサー
│   │   │   └── mappings/        # カード会社別マッピング定義
│   │   │       ├── epos.ts      # エポスカード
│   │   │       └── index.ts
│   │   ├── ai/                  # Claude API連携ロジック
│   │   │   ├── client.ts        # Anthropic Client初期化
│   │   │   ├── categorize.ts    # カテゴリ分類
│   │   │   └── report.ts        # レポート生成
│   │   ├── privacy/             # プライバシーフィルター
│   │   │   └── filter.ts        # 公開レベルに応じたフィルタリング
│   │   └── utils.ts             # 汎用ユーティリティ
│   └── types/                   # 型定義
│       └── index.ts
├── public/                      # 静的ファイル
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

---

## 6. コスト試算

### 月額ランニングコスト（運用時）

| サービス | プラン | 月額 | 備考 |
|---------|--------|------|------|
| Claude (Plus) | $20プラン | 約¥3,000 | 開発 + アプリ内AI機能 |
| Vercel | Hobby（無料） | ¥0 | 個人利用なら無料枠で十分 |
| Supabase | Free | ¥0 | 500MB DB、50,000行まで |
| LINE Messaging API | 無料プラン | ¥0 | 月200通まで（夫婦2人なら十分） |
| **合計** | | **約¥3,000/月** | |

### アプリ内Claude API呼び出しのコスト

アプリ内からClaude APIを呼ぶ場合（カテゴリ分類・レポート生成）は、Anthropicの従量課金APIを使います。これはPlusプランとは別料金です。

| 用途 | 頻度 | 推定トークン/回 | 月額目安 |
|------|------|----------------|---------|
| カテゴリ分類（Haiku） | 月2回 × 50件 | 入力1K + 出力0.5K | ¥5程度 |
| 月次レポート（Sonnet） | 月1回 | 入力3K + 出力2K | ¥5程度 |
| チャットアドバイザー（Sonnet） | 月数回 | 入力2K + 出力1K | ¥10程度 |
| **API合計** | | | **¥20〜50/月** |

**Haiku 4.5をカテゴリ分類に使うことでコスト大幅削減**。店舗名→カテゴリの単純な分類タスクにはHaikuで十分で、Sonnetの1/10以下のコスト。

### Pro ($100/月) への切り替え判断基準

- 開発中にPlusのリミットに頻繁に当たる（1日2回以上）
- 1セッションで大規模なコード生成が必要になる
- Claude Codeの応答品質をOpusに上げたい場合

---

## 7. 開発の進め方（Claude Code実践ガイド）

### 推奨ワークフロー

```
①要件確認         → claude.ai（このチャット）で方針を相談
②設計・実装       → Claude Code でコード生成・編集
③動作確認         → ブラウザで確認（Playwright MCPも活用）
④デバッグ         → Claude Code にエラーを貼って修正依頼
⑤Git管理          → Claude Code or ターミナルでcommit/push
```

### Phase 1 のClaude Code活用例

```bash
# 1. プロジェクト初期化後にClaude Codeを起動
cd ~/projects/kakeishare
claude

# 2. Prismaスキーマの作成
> 要件定義書のデータモデルに基づいてprisma/schema.prismaを作成して。
> テーブル: users, expenses, categories, budgets, installments, csv_imports
> expensesにはvisibilityカラム（PUBLIC/AMOUNT_ONLY/CATEGORY_TOTAL）を含める
> categoriesにはdefault_visibilityカラムを含める

# 3. 認証の設定
> NextAuth.jsでCredentials認証を設定して。
> 夫と妻の2ユーザーをseedデータで用意して

# 4. レイアウトの作成
> モバイルファーストのレイアウトを作成して。
> 下部にナビゲーションバー（ホーム/支出/予算/設定）
> shadcn/uiのコンポーネントを使って
```

---

## 8. 注意点・Tips

### TypeScript未経験でも大丈夫な理由

- Claude Codeが型定義を自動生成してくれる
- Prismaがスキーマから完全な型を生成するため、手動で型を書く場面が少ない
- エラーが出てもClaude Codeに「このエラー直して」で解決できることが多い
- 最初は読むだけでOK。書き方はClaude Codeから学べる

### よくあるハマりポイント

| 問題 | 対処 |
|------|------|
| Prisma Client が古い | `pnpm prisma generate` を実行 |
| Next.js の "use client" エラー | Server ComponentでuseStateやonClickを使おうとしている。"use client" を先頭に追加 |
| MCP サーバーが failed | `/mcp` で確認 → `claude mcp remove` → 再追加 |
| Claude Codeのリミット到達 | `/status` で確認。5時間待つか、新セッションで小さいタスクから再開 |
| SQLiteのマイグレーションがおかしい | `prisma/dev.db` を削除して `pnpm prisma migrate dev` をやり直す |

### Claude Code のコンテキスト管理

Plusプランではコンテキストの効率的な利用が重要です。

- **長い会話は分割**: 機能ごとに新しいセッションを始める
- **ファイルの指定**: `@src/lib/db.ts` のように具体的なファイルパスを指定
- **CLAUDE.md活用**: 毎回説明する内容はCLAUDE.mdに書いておく
- **コンパクトなプロンプト**: 必要な情報を簡潔にまとめて伝える
