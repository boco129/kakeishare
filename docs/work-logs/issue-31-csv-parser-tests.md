# Issue #31: CSVパーサー（parseCsv）のユニットテスト追加

## 対応日

2026-02-28

## ブランチ

`feature/issue-31-csv-parser-tests`（develop から分岐）

## 作成ファイル

| ファイル | 内容 |
|---------|------|
| `src/lib/csv/parser.test.ts` | parseCsv のユニットテスト（26ケース） |

## 実装詳細

### テスト対象

`src/lib/csv/parser.ts` の `parseCsv` 関数。
CSVバイナリを読み込み、エンコード変換 → パース → マッピング適用で正規化を行うロジック。

### テスト方法

実際の CardCsvDefinition（eposMapping, mufgJcbMapping, mufgVisaMapping）を使用し、CSV文字列を Buffer 化して parseCsv に渡すインテグレーション寄りのユニットテスト。

### テストケース（26件）

| カテゴリ | # | テスト内容 |
|---------|---|-----------|
| エンコーディング | 1 | Shift_JIS → UTF-8 変換 |
| エンコーディング | 2 | UTF-8 入力がそのまま処理 |
| 日付パース | 3 | YYYY/MM/DD → YYYY-MM-DD 変換 |
| 日付パース | 4 | YYYY-MM-DD がそのまま処理 |
| 日付パース | 5 | 不正な日付文字列 → 行スキップ |
| 日付パース | 6 | 存在しない日付（2/30）→ 行スキップ |
| 金額変換 | 7 | 通常の整数金額 |
| 金額変換 | 8 | カンマ区切り金額 |
| 金額変換 | 9 | 負数表記 (1234) |
| 金額変換 | 10 | 全角数字 → 半角変換 |
| 金額変換 | 11 | ¥/￥ + 全角カンマ正規化 |
| 金額変換 | 12 | カンマ区切り負数 (1,234) |
| 金額変換 | 13 | 不正な金額文字列 → 行スキップ |
| カードマッピング | 14 | エポスカード正規化 |
| カードマッピング | 15 | MUFG JCB 正規化 |
| カードマッピング | 16 | MUFG JCB 分割払い回数抽出 |
| カードマッピング | 17 | MUFG VISA 正規化 |
| カードマッピング | 18 | MUFG VISA alternateColumns フォールバック |
| カードマッピング | 19 | MUFG VISA 分割払い回数抽出 |
| エッジケース | 20 | 空CSV（ヘッダーのみ）→ 空配列 |
| エッジケース | 21 | 複数行の全正規化 |
| エッジケース | 22 | 必須 description 空 → 行スキップ |
| エッジケース | 23 | 必須 date 空 → 行スキップ |
| エッジケース | 24 | 必須 amount 空 → 行スキップ |
| エッジケース | 25 | skipRows 反映 |
| エッジケース | 26 | 不正CSV（クォート崩れ）→ 例外 |

## Codexレビュー指摘と対応

### 初回レビュー指摘

| 重要度 | 指摘 | 対応 |
|-------|------|------|
| 中 | skipRows の挙動が未検証 | テストケース25として追加 |
| 中 | 必須カラム空チェックが description のみ | date 空・amount 空を個別テスト追加 |
| 低 | ¥/￥、全角カンマ、(1,234) 形式のテスト不足 | ￥１，２３４ と (1,234) のテスト追加 |
| 低 | 不正CSV時の例外テストなし | クォート崩れで throw するテスト追加 |

### 再レビュー結果

全4点の指摘反映を確認し、**承認**を取得。

## テスト結果

- parser.test.ts: 26/26 pass
- 全体: 153/153 pass（既存テストへの影響なし）

## 将来の課題

- csv-parse のエラーコード（CSV_QUOTE_NOT_CLOSED 等）まで検証するとより堅牢
- skipRows 複数行スキップのテスト追加
