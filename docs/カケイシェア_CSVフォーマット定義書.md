# カケイシェア CSVフォーマット定義書

> **最終更新**: 2026-02-23
> **ステータス**: 調査ベース（実CSVで要検証）

---

## 1. 設計方針

### カード会社は動的に追加可能にする

カード会社ごとにCSVフォーマットが異なるため、**カラムマッピング定義**をJSON形式で管理し、新しいカード会社を設定ファイルの追加だけで対応できるようにする。

```
CSVファイル → カラムマッピング定義で正規化 → 共通フォーマット → DB保存
```

### 共通フォーマット（正規化後）

すべてのCSVは、カラムマッピングを経て以下の共通フォーマットに変換される。

| フィールド | 型 | 説明 | 必須 |
|-----------|------|------|------|
| date | string (YYYY-MM-DD) | 利用日 | ✅ |
| description | string | 利用先・店舗名 | ✅ |
| amount | number | 利用金額（正の整数、円） | ✅ |
| payment_method | string | 支払区分（1回、分割、リボ等） | ❌ |
| installment_count | number | 分割回数（分割払いの場合） | ❌ |
| memo | string | 備考・補足情報 | ❌ |

---

## 2. カード会社別フォーマット

### 2.1 エポスカード（妻・確定）

**ダウンロード場所**: エポスNet → 月別ご利用履歴照会 → CSVダウンロード（PCのみ）

**注意事項**:
- CSVダウンロードはPC限定（スマホ不可）
- 月別ご利用履歴からCSV形式で過去分もダウンロード可能
- 当月引落分はCSV、過去分はPDFでも提供
- エンコーディング: Shift_JIS（要確認）

**推定フォーマット**:

> ⚠️ 以下は調査に基づく推定です。実際にダウンロードして列名・列数を確認してください。

```csv
ご利用日,ご利用先・商品名,ご利用金額,お支払区分,今回お支払金額,備考
2026/01/05,スターバックス 渋谷店,580,1回払い,580,
2026/01/08,Amazon.co.jp,3200,1回払い,3200,
2026/01/12,居酒屋 魚民 新宿店,15800,1回払い,15800,
2026/01/15,ZARA オンラインストア,12000,3回払い,4000,
```

**カラムマッピング定義**:

```json
{
  "id": "epos",
  "name": "エポスカード",
  "encoding": "Shift_JIS",
  "skipRows": 0,
  "hasHeader": true,
  "delimiter": ",",
  "mapping": {
    "date": {
      "column": "ご利用日",
      "format": "YYYY/MM/DD"
    },
    "description": {
      "column": "ご利用先・商品名"
    },
    "amount": {
      "column": "ご利用金額",
      "type": "integer"
    },
    "payment_method": {
      "column": "お支払区分"
    },
    "memo": {
      "column": "備考"
    }
  },
  "notes": "PCのみCSVダウンロード可。月別ご利用履歴照会から取得。"
}
```

### 2.2 MUFG JCBカード（夫）

**ダウンロード場所**: MyJCB → カードご利用代金明細照会 → CSV形式でダウンロード

**注意事項**:
- 最長15ヵ月分の確定分明細がダウンロード可能
- 本会員のみ利用可（家族会員は不可）
- ショッピングリボ・分割払いは月々のお支払い金額と新規利用額の両方が含まれる
- 一部文字が文字化けする可能性あり

**推定フォーマット**:

> ⚠️ JCBのCSVフォーマットはMyJCBの仕様に準拠。実CSVで要検証。

```csv
ご利用年月日,ご利用先など,お支払区分,ご利用金額,手数料,お支払合計,お支払月,お支払金額
2026/01/03,ヨドバシカメラ マルチメディアAkiba,1回,45000,,45000,2026/02,45000
2026/01/07,東京電力EP,1回,8500,,8500,2026/02,8500
2026/01/10,Suica チャージ,1回,5000,,5000,2026/02,5000
2026/01/18,Apple.com/bill,3回,36000,1200,37200,2026/02,12400
```

**カラムマッピング定義**:

```json
{
  "id": "mufg_jcb",
  "name": "MUFG JCBカード",
  "encoding": "Shift_JIS",
  "skipRows": 0,
  "hasHeader": true,
  "delimiter": ",",
  "mapping": {
    "date": {
      "column": "ご利用年月日",
      "format": "YYYY/MM/DD"
    },
    "description": {
      "column": "ご利用先など"
    },
    "amount": {
      "column": "ご利用金額",
      "type": "integer"
    },
    "payment_method": {
      "column": "お支払区分"
    },
    "installment_count": {
      "extractFrom": "お支払区分",
      "pattern": "^(\\d+)回$"
    },
    "memo": {
      "column": null
    }
  },
  "notes": "MyJCBから確定分をダウンロード。最長15ヵ月分。"
}
```

### 2.3 MUFG VISAカード（夫）

**ダウンロード場所**: My Digital Connect → 請求額・利用明細照会 → ご利用明細のダウンロード

**注意事項**:
- MUFG VISAカードの会員サイトは「My Digital Connect」（旧Vpass系）
- CSV形式でダウンロード可能

**推定フォーマット**:

> ⚠️ MUFG VISAのCSVは三井住友系のフォーマットに近い可能性あり。実CSVで要検証。

```csv
ご利用日,ご利用先,利用区分,ご利用金額（税込）,手数料,支払金額,支払月
2026/01/02,コストコホールセール,1回払い,28500,,28500,2026/02
2026/01/06,ENEOSサービスステーション,1回払い,6800,,6800,2026/02
2026/01/14,楽天市場,1回払い,4500,,4500,2026/02
2026/01/20,ニトリ オンラインショップ,分割3回,24000,800,8267,2026/02
```

**カラムマッピング定義**:

```json
{
  "id": "mufg_visa",
  "name": "MUFG VISAカード",
  "encoding": "Shift_JIS",
  "skipRows": 0,
  "hasHeader": true,
  "delimiter": ",",
  "mapping": {
    "date": {
      "column": "ご利用日",
      "format": "YYYY/MM/DD"
    },
    "description": {
      "column": "ご利用先"
    },
    "amount": {
      "column": "ご利用金額（税込）",
      "alternateColumns": ["ご利用金額"],
      "type": "integer"
    },
    "payment_method": {
      "column": "利用区分"
    },
    "installment_count": {
      "extractFrom": "利用区分",
      "pattern": "分割(\\d+)回"
    },
    "memo": {
      "column": null
    }
  },
  "notes": "My Digital Connectからダウンロード。"
}
```

---

## 3. カラムマッピングシステムの設計

### 3.1 マッピング定義のスキーマ

```typescript
// src/types/csv-mapping.ts

interface CsvColumnMapping {
  /** CSVのヘッダー名（完全一致） */
  column: string | null;
  /** カラム名が複数の可能性がある場合のフォールバック */
  alternateColumns?: string[];
  /** 日付のパース形式 */
  format?: string;
  /** 数値型の指定 */
  type?: "integer" | "float";
  /** 別カラムから正規表現で値を抽出する場合 */
  extractFrom?: string;
  /** 抽出用の正規表現パターン */
  pattern?: string;
}

interface CardCsvDefinition {
  /** 一意の識別子 */
  id: string;
  /** 表示名 */
  name: string;
  /** ファイルエンコーディング */
  encoding: "UTF-8" | "Shift_JIS" | "EUC-JP";
  /** ヘッダー行前にスキップする行数 */
  skipRows: number;
  /** ヘッダー行の有無 */
  hasHeader: boolean;
  /** 区切り文字 */
  delimiter: string;
  /** 共通フォーマットへのマッピング */
  mapping: {
    date: CsvColumnMapping;
    description: CsvColumnMapping;
    amount: CsvColumnMapping;
    payment_method?: CsvColumnMapping;
    installment_count?: CsvColumnMapping;
    memo?: CsvColumnMapping;
  };
  /** 運用上の補足メモ */
  notes?: string;
}
```

### 3.2 マッピング定義の保存場所

```
src/lib/csv/mappings/
├── index.ts           # 全マッピング定義のエクスポート
├── epos.ts            # エポスカード
├── mufg-jcb.ts        # MUFG JCBカード
├── mufg-visa.ts       # MUFG VISAカード
└── custom.ts          # ユーザーがUI上で定義したカスタムマッピング（DB保存）
```

### 3.3 新しいカード会社の追加手順

1. 実際のCSVファイルをダウンロードしてフォーマットを確認
2. `src/lib/csv/mappings/` に新しい定義ファイルを作成
3. `index.ts` にエクスポートを追加
4. アプリのCSV取り込み画面のカード選択プルダウンに自動的に表示される

### 3.4 UIでのカスタムマッピング機能

既知のカード以外にも対応できるよう、UIからカラムマッピングを定義する機能も用意する。

**フロー**:
1. ユーザーがCSVをアップロード
2. ヘッダー行を自動検出して列名を表示
3. 各列を「日付」「店舗名」「金額」等にドラッグ＆ドロップまたは選択で対応付け
4. マッピングを名前付きで保存（例: 「楽天カード」）
5. 次回以降は保存済みマッピングを選択するだけ

---

## 4. サンプルCSVデータ（開発・テスト用）

### 4.1 エポスカード サンプル（妻）

日常的な支出に加え、以下の特殊ケースを含む:
- 飲み会の立替払い（高額・交際費）
- 分割払い
- 返金（マイナス金額）
- Amazon等の通販（カテゴリ判定が難しいケース）

```csv
ご利用日,ご利用先・商品名,ご利用金額,お支払区分,今回お支払金額,備考
2026/01/03,マルエツ 豊洲店,2480,1回払い,2480,
2026/01/05,スターバックス 渋谷店,580,1回払い,580,
2026/01/07,Amazon.co.jp,3200,1回払い,3200,
2026/01/08,セブン-イレブン 勝どき駅前店,890,1回払い,890,
2026/01/10,ユニクロ ららぽーと豊洲,5980,1回払い,5980,
2026/01/12,居酒屋 魚民 新宿東口店,18500,1回払い,18500,
2026/01/14,マツモトキヨシ 月島店,1240,1回払い,1240,
2026/01/15,ZARA オンラインストア,12000,3回払い,4000,
2026/01/17,東京メトロ 定期券,8400,1回払い,8400,
2026/01/18,Netflix,1490,1回払い,1490,
2026/01/20,焼肉きんぐ 豊洲店,25600,1回払い,25600,
2026/01/22,ダイソー 豊洲店,330,1回払い,330,
2026/01/24,ホットペッパービューティー,7800,1回払い,7800,
2026/01/25,Amazon.co.jp,-1200,1回払い,-1200,返品
2026/01/27,サイゼリヤ 勝どき店,1850,1回払い,1850,
2026/01/28,Spotify,980,1回払い,980,
2026/01/30,ドン・キホーテ 銀座本館,4560,1回払い,4560,
```

### 4.2 MUFG JCBカード サンプル（夫）

固定費中心の支出パターン:

```csv
ご利用年月日,ご利用先など,お支払区分,ご利用金額,手数料,お支払合計,お支払月,お支払金額
2026/01/03,ヨドバシカメラ マルチメディアAkiba,1回,45000,,45000,2026/02,45000
2026/01/05,東京電力エナジーパートナー,1回,8500,,8500,2026/02,8500
2026/01/05,東京ガス,1回,4200,,4200,2026/02,4200
2026/01/06,NTTドコモ,1回,8800,,8800,2026/02,8800
2026/01/07,au（KDDI）,1回,5500,,5500,2026/02,5500
2026/01/08,Suica チャージ オートチャージ,1回,5000,,5000,2026/02,5000
2026/01/10,Amazon.co.jp,1回,2800,,2800,2026/02,2800
2026/01/12,コストコホールセール 幕張倉庫店,1回,18900,,18900,2026/02,18900
2026/01/14,ENEOSサービスステーション,1回,6800,,6800,2026/02,6800
2026/01/15,Apple.com/bill,3回,36000,1200,37200,2026/02,12400
2026/01/17,SBI損保 自動車保険,1回,4500,,4500,2026/02,4500
2026/01/20,楽天市場,1回,3400,,3400,2026/02,3400
2026/01/22,マクドナルド 豊洲店,1回,1280,,1280,2026/02,1280
2026/01/25,Y!mobile,1回,3200,,3200,2026/02,3200
2026/01/28,Amazon Prime会費,1回,600,,600,2026/02,600
```

### 4.3 MUFG VISAカード サンプル（夫）

```csv
ご利用日,ご利用先,利用区分,ご利用金額（税込）,手数料,支払金額,支払月
2026/01/02,西友 豊洲店,1回払い,5600,,5600,2026/02
2026/01/09,ニトリ オンラインショップ,分割3回,24000,800,8267,2026/02
2026/01/11,スシロー 豊洲店,1回払い,4200,,4200,2026/02
2026/01/16,JR東日本 えきねっと,1回払い,12000,,12000,2026/02
2026/01/19,ビックカメラ.com,1回払い,8900,,8900,2026/02
2026/01/23,サンドラッグ 月島店,1回払い,2100,,2100,2026/02
2026/01/26,Uber Eats,1回払い,2800,,2800,2026/02
2026/01/29,東京都水道局,1回払い,3400,,3400,2026/02
```

---

## 5. CSV解析の実装指針

### 5.1 パーサーの責務

```
CSVファイル
  → エンコーディング変換（Shift_JIS → UTF-8）
  → ヘッダー行スキップ（skipRows）
  → papaparse で解析
  → カラムマッピング適用（列名 → 共通フォーマット）
  → バリデーション（日付・金額の検証）
  → 重複チェック（date + description + amount のハッシュ）
  → DB保存
```

### 5.2 重複検知ロジック

```typescript
// 重複判定用ハッシュ生成
function generateExpenseHash(
  date: string,
  description: string,
  amount: number
): string {
  const input = `${date}|${description}|${amount}`;
  return crypto.createHash("sha256").update(input).digest("hex").slice(0, 16);
}
```

**注意**: 同じ日に同じ店で同じ金額を2回使うケースは稀だが起こりうる。取り込み時にWarningを表示し、ユーザーに確認させる。

### 5.3 エンコーディング処理

日本のカード会社のCSVは多くがShift_JISで出力される。ブラウザ上での処理には変換が必要。

```typescript
// ブラウザ側でShift_JIS → UTF-8変換
const decoder = new TextDecoder("shift_jis");
const text = decoder.decode(fileBuffer);
```

---

## 6. 検証チェックリスト

実際のCSVをダウンロードしたら、以下の項目を確認してこのドキュメントを更新する。

### エポスカード
- [ ] 実際のヘッダー行の列名を確認
- [ ] ヘッダー前にスキップすべき行があるか確認
- [ ] エンコーディングを確認（Shift_JIS / UTF-8）
- [ ] 日付フォーマットを確認（YYYY/MM/DD or YYYY-MM-DD等）
- [ ] 金額にカンマ区切りがあるか確認（例: 1,200 vs 1200）
- [ ] 分割払い・リボ払いの表記を確認
- [ ] 返金・キャンセルの表記を確認（マイナス金額？別列？）

### MUFG JCBカード
- [ ] MyJCBからの実際のCSVヘッダーを確認
- [ ] 列の順序と列数を確認
- [ ] 支払区分の表記バリエーションを確認（1回、2回、ボ1、リボ等）
- [ ] エンコーディングを確認

### MUFG VISAカード
- [ ] My Digital Connectからの実際のCSVヘッダーを確認
- [ ] エポスやJCBとのフォーマット差異を確認
- [ ] エンコーディングを確認
